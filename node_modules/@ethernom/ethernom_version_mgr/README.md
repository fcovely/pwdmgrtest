### Installation:
```bash
npm install @ethernom/ethernom_download_mgr
```

### Depndencies:
- buffer
- @ethernom/ethernom-api
- react-native-fs
- react-native-nordic-dfu
- rn-fetch-blob

### iOS:
Add the following to your Podfile
```bash
target "YourApp" do
	...
	use_frameworks!
	pod "react-native-nordic-dfu", path: "../node_modules/react-native-nordic-dfu"
	...
end
```

and in the same folder as the Podfile run
```bash
pod install
```

### Android:
Add the following to your AndroidManifest.xml
```bash
	...
	<uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
	<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
	<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
	<uses-permission android:name="android.permission.DOWNLOAD_WITHOUT_NOTIFICATION" />
	...
```

### How-To: Where to upload main firmware image Direct Path to:
1. Add main firmware image files to iOS/Android.
- On iOS, drag and drop firmware file into project in Xcode. Remember to check "Copy items if needed" option and "Add to targets".
- On Android, put firmware files in {project_root}/android/app/src/main/assets/. Just create the folder if it doesn't exist.

### How-To: Where to upload ble firmware image Direct URL Path to:
1. Upload ble firmware zip files to a secure server.

<br />

### API CALLS:

### How-To: Init Ethernom Downloader API:
Parameter 1: JSON{STRING verison, STRING path(file name)} - Main Version assets (TBC), or NULL<br />
Parameter 2: JSON{STRING verison, STRING path(direct URL)} - BLE Version assets (TBC), or NULL<br />
If NULL -> default path define by the API 
```bash
import {DL_MGR} from "ethernom_download_mgr";
var MAIN_DL_API = new DL_MGR(MAIN_VERSION, BLE_VERSION);
```

### How-To: Request check current device version:
Parameter 1: EthernomAPI - the current Ethernom API that uses to communicate with the connected device<br />
Parameter 2: FUNCTION - Callback<br />
Callback: BOOLEAN - trigger update main, BOOLEAN - trigger update ble, BOOLEAN - batter low & BOOLEAN - auto mode
```bash
MAIN_DL_API.request_check_version(E_API, deviceID, deviceName, callback = (update_main, update_ble, battery_low, auto) => {
	if(update_main == true) //TRIGGER MAIN FIRMWARE UPDATE
	if(update_ble == true) //TRIGGER BLE FIRMWARE UPDATE
	if(battery_low == true) //TRIGGER CURRENT DEVICE LOW BATTERY 
	if(auto == true) //Start loading without ackwnowledge from UI
});
```

### How-To: Start Nordic firmware bootloader:
Precondition: Only call this after check version, and trigger update main == true;<br />
Parameter 1: EthernomAPI - the current Ethernom API that uses to communicate with the connected device<br />
Parameter 2: STRING - current device name<br />
Parameter 3: FUNCTION - Callback
```bash
MAIN_DL_API.request_init_dfu(E_API, deviceName, callback = () => {
	//CLOSE YOUR CURRENT DEVICE CONNECTION
});
```

### How-To: Start main firmware bootloader:
Precondition: Only call this after check version, and trigger update ble == true;<br />
Parameter 1: EthernomAPI - the current Ethernom API that uses to communicate with the connected device<br />
Parameter 2: STRING - current device id<br />
Parameter 3: STRING - current device name<br />
Parameter 4: FUNCTION - Callback
```bash
MAIN_DL_API.request_init_dl(E_API, deviceID, deviceName, callback = () => {
	//CLOSE YOUR CURRENT DEVICE CONNECTION
});
```

### How-To: See progress:
Parameter 1: FUNCTION - Callback<br />
Callback: STRING - type, INT/DOUBLE - percent
```bash
MAIN_DL_API.subscribe_progress(callback = (type, percent) => {
	console.log(type); //"BLE" or "MAIN"
	console.log(percent); //0 ~ 100 & -1(error)
});
```


### Note: iOS react-native-nordic-dfu
Go to -> node_modules/react-native-nordic-dfu/ios/RNNordicDfu.m
Replace 

Go to -> main project/ios/[PROJECT].xcworkspace
Add lines to:
```bash
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
    
    ...
    [RNNordicDfu setCentralManagerGetter:^() {
        return [[CBCentralManager alloc] initWithDelegate:nil queue:dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0)];
    }];

    // Reset manager delegate since the Nordic DFU lib "steals" control over it
    [RNNordicDfu setOnDFUComplete:^() {
        NSLog(@"onDFUComplete");
    }];

    [RNNordicDfu setOnDFUError:^() {
        NSLog(@"onDFUError");
    }];
    
    ...
    return YES;
}
```
